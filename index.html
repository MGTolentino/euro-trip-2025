<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Viaje - Europa 2025</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úàÔ∏è</text></svg>">
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAI2ofzM5BdlqK7glDAz5OPZ-L5Oslf_28",
            authDomain: "euro-trip-2025.firebaseapp.com",
            databaseURL: "https://euro-trip-2025-default-rtdb.firebaseio.com/",
            projectId: "euro-trip-2025",
            storageBucket: "euro-trip-2025.firebasestorage.app",
            messagingSenderId: "218713594766",
            appId: "1:218713594766:web:e84557d13d976e327d62df"
        };

        let app, database;
        let isFirebaseConnected = false;

        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            isFirebaseConnected = true;
        } catch (error) {
            console.error('Error Firebase:', error);
        }

        // Datos basados exactamente en tu Excel
        const initialData = {
            itinerario: [
                { id: 1, fecha: "2024-12-20", diaSemana: "S√°bado", ciudadOrigen: "", ciudadDestino: "Zurich", paisDestino: "Suiza", rutaTransporte: "", noches: "", costoTransporte: "", costoAlojamiento: "", actividades: "Desayuno", notas: "" },
                { id: 2, fecha: "2024-12-21", diaSemana: "Domingo", ciudadOrigen: "", ciudadDestino: "Zurich/Lucerna", paisDestino: "Suiza", rutaTransporte: "", noches: "", costoTransporte: "", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 3, fecha: "2024-12-22", diaSemana: "Lunes", ciudadOrigen: "", ciudadDestino: "Zurich", paisDestino: "Suiza", rutaTransporte: "", noches: "3", costoTransporte: "8100", costoAlojamiento: "", actividades: "", notas: "Tren redondo" },
                { id: 4, fecha: "2024-12-23", diaSemana: "Martes", ciudadOrigen: "", ciudadDestino: "St Moritz", paisDestino: "Suiza", rutaTransporte: "", noches: "2", costoTransporte: "25000", costoAlojamiento: "", actividades: "", notas: "Tren Directo (Zurich - ST Moritz)" },
                { id: 5, fecha: "2024-12-24", diaSemana: "Mi√©rcoles", ciudadOrigen: "", ciudadDestino: "St Moritz", paisDestino: "Suiza", rutaTransporte: "", noches: "", costoTransporte: "", costoAlojamiento: "", actividades: "", notas: "Tren directo (St Moritz - Tirano)" },
                { id: 6, fecha: "2024-12-25", diaSemana: "Jueves", ciudadOrigen: "St Moritz/Tirano", ciudadDestino: "Milan", paisDestino: "Italia", rutaTransporte: "Tren Directo (Tirano - Milan)", noches: "", costoTransporte: "1200", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 7, fecha: "2024-12-26", diaSemana: "Viernes", ciudadOrigen: "", ciudadDestino: "Milan", paisDestino: "Italia", rutaTransporte: "", noches: "", costoTransporte: "", costoAlojamiento: "", actividades: "", notas: "Tren Redondo (Milan-Turin)" },
                { id: 8, fecha: "2024-12-27", diaSemana: "S√°bado", ciudadOrigen: "", ciudadDestino: "Milan/Turin", paisDestino: "Italia", rutaTransporte: "", noches: "4", costoTransporte: "15000", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 9, fecha: "2024-12-28", diaSemana: "Domingo", ciudadOrigen: "", ciudadDestino: "milan/juego", paisDestino: "Italia", rutaTransporte: "", noches: "1", costoTransporte: "7500", costoAlojamiento: "", actividades: "", notas: "Tren Directo (Milan-Florencia)" },
                { id: 10, fecha: "2024-12-29", diaSemana: "Lunes", ciudadOrigen: "", ciudadDestino: "milan/Florencia", paisDestino: "Italia", rutaTransporte: "Tren Directo (Florencia-Pisa)", noches: "", costoTransporte: "900", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 11, fecha: "2024-12-30", diaSemana: "Martes", ciudadOrigen: "", ciudadDestino: "florencia/pisa/Roma", paisDestino: "Italia", rutaTransporte: "", noches: "3", costoTransporte: "26000", costoAlojamiento: "", actividades: "", notas: "Tren Directo (Pisa-Roma)" },
                { id: 12, fecha: "2024-12-31", diaSemana: "Mi√©rcoles", ciudadOrigen: "", ciudadDestino: "Roma", paisDestino: "Italia", rutaTransporte: "", noches: "", costoTransporte: "", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 13, fecha: "2025-01-01", diaSemana: "Jueves", ciudadOrigen: "", ciudadDestino: "Roma", paisDestino: "Italia", rutaTransporte: "", noches: "3", costoTransporte: "26000", costoAlojamiento: "", actividades: "", notas: "Tren Directo (Roma-Venecia)" },
                { id: 14, fecha: "2025-01-02", diaSemana: "Viernes", ciudadOrigen: "", ciudadDestino: "Roma/Venecia", paisDestino: "Italia", rutaTransporte: "", noches: "2", costoTransporte: "23000", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 15, fecha: "2025-01-03", diaSemana: "S√°bado", ciudadOrigen: "", ciudadDestino: "Venecia", paisDestino: "Italia", rutaTransporte: "", noches: "1", costoTransporte: "7000", costoAlojamiento: "", actividades: "", notas: "Tren Directo (Venecia-Verona)" },
                { id: 16, fecha: "2025-01-04", diaSemana: "Domingo", ciudadOrigen: "", ciudadDestino: "Venecia/Verona", paisDestino: "Italia", rutaTransporte: "", noches: "1", costoTransporte: "2700", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 17, fecha: "2025-01-05", diaSemana: "Lunes", ciudadOrigen: "", ciudadDestino: "Verona/Zurich", paisDestino: "Suiza", rutaTransporte: "Tren (Verona - Zurich)", noches: "", costoTransporte: "6000", costoAlojamiento: "", actividades: "", notas: "" },
                { id: 18, fecha: "2025-01-06", diaSemana: "Martes", ciudadOrigen: "", ciudadDestino: "Verona/Zurich", paisDestino: "M√©xico", rutaTransporte: "6:30pm, salida a mty", noches: "", costoTransporte: "114300", costoAlojamiento: "36300", actividades: "", notas: "" }
            ],
            actividades: {},
            gastos: [],
            presupuesto: {
                ingresos: [],
                totalPlanificado: 0
            }
        };

        let viajeData = {};

        async function saveData(path, data) {
            if (isFirebaseConnected) {
                try {
                    await set(ref(database, path), data);
                } catch (error) {
                    console.error('Error guardando:', error);
                }
            }
        }

        async function loadData(path) {
            if (isFirebaseConnected) {
                try {
                    const snapshot = await get(ref(database, path));
                    return snapshot.exists() ? snapshot.val() : null;
                } catch (error) {
                    console.error('Error cargando:', error);
                }
            }
            return null;
        }

        window.addEventListener('DOMContentLoaded', async function() {
            const savedData = await loadData('viajeData');
            viajeData = savedData || initialData;
            
            if (!savedData) {
                await saveData('viajeData', viajeData);
            }

            renderApp();
        });

        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header">
                    <h1>üåç Viaje Europa 2025</h1>
                    <div class="stats">
                        <span class="stat">üìÖ ${viajeData.itinerario.length} d√≠as</span>
                        <span class="stat">üèôÔ∏è ${getCiudadesUnicas().length} ciudades</span>
                        <span class="stat">üí∞ $${calcularTotalGastos().toLocaleString()}</span>
                        <span class="stat ${isFirebaseConnected ? 'connected' : 'offline'}">
                            ${isFirebaseConnected ? 'üü¢ Online' : 'üî¥ Offline'}
                        </span>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('itinerario')">üìã Itinerario</button>
                    <button class="tab-btn" onclick="showTab('actividades')">üéØ Actividades</button>
                    <button class="tab-btn" onclick="showTab('presupuesto')">üí∞ Presupuesto</button>
                    <button class="tab-btn" onclick="showTab('gastos')">üßæ Gastos</button>
                </div>

                <div id="itinerario" class="tab-content active">
                    ${renderItinerario()}
                </div>
                
                <div id="actividades" class="tab-content">
                    ${renderActividades()}
                </div>
                
                <div id="presupuesto" class="tab-content">
                    ${renderPresupuesto()}
                </div>
                
                <div id="gastos" class="tab-content">
                    ${renderGastos()}
                </div>
            `;
        }

        function renderItinerario() {
            return `
                <div class="table-container">
                    <table class="itinerario-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>D√≠a</th>
                                <th>Origen ‚Üí Destino</th>
                                <th>Pa√≠s</th>
                                <th>Ruta/Transporte</th>
                                <th>Noches</th>
                                <th>Costo Transporte</th>
                                <th>Costo Alojamiento</th>
                                <th>Actividades</th>
                                <th>Notas</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${viajeData.itinerario.map(dia => `
                                <tr class="day-row">
                                    <td class="fecha">${formatDateShort(dia.fecha)}</td>
                                    <td>${dia.diaSemana || ''}</td>
                                    <td class="ruta">
                                        ${dia.ciudadOrigen ? `${dia.ciudadOrigen} ‚Üí ` : ''}${dia.ciudadDestino}
                                    </td>
                                    <td>${dia.paisDestino}</td>
                                    <td class="transporte">${dia.rutaTransporte || '-'}</td>
                                    <td class="center">${dia.noches || '-'}</td>
                                    <td class="costo">${dia.costoTransporte ? '$' + parseInt(dia.costoTransporte).toLocaleString() : '-'}</td>
                                    <td class="costo">${dia.costoAlojamiento ? '$' + parseInt(dia.costoAlojamiento).toLocaleString() : '-'}</td>
                                    <td class="actividades-cell">
                                        ${getActividadesDia(dia.id) || dia.actividades || '-'}
                                    </td>
                                    <td class="notas">${dia.notas || '-'}</td>
                                    <td class="actions">
                                        <button onclick="editRow(${dia.id})" class="btn-edit">‚úèÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="actions-bar">
                    <button onclick="addDay()" class="btn-primary">‚ûï Agregar D√≠a</button>
                    <button onclick="exportData()" class="btn-secondary">üì§ Exportar</button>
                </div>
            `;
        }

        function renderActividades() {
            const ciudades = getCiudadesUnicas();
            
            return `
                <div class="actividades-container">
                    <div class="actividades-header">
                        <h3>üéØ Actividades por Ciudad</h3>
                        <button onclick="addCiudadActividades()" class="btn-primary">‚ûï Nueva Ciudad</button>
                    </div>
                    
                    <div class="ciudades-grid">
                        ${ciudades.map(ciudad => `
                            <div class="ciudad-card">
                                <div class="ciudad-header">
                                    <h4>${ciudad}</h4>
                                    <button onclick="addActividad('${ciudad}')" class="btn-small">‚ûï</button>
                                </div>
                                <div class="actividades-list">
                                    ${(viajeData.actividades[ciudad] || []).map((actividad, index) => `
                                        <div class="actividad-item">
                                            <span class="actividad-text">${actividad}</span>
                                            <div class="actividad-actions">
                                                <button onclick="editActividad('${ciudad}', ${index})" class="btn-tiny">‚úèÔ∏è</button>
                                                <button onclick="deleteActividad('${ciudad}', ${index})" class="btn-tiny">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${(viajeData.actividades[ciudad] || []).length === 0 ? '<p class="empty-activities">No hay actividades</p>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPresupuesto() {
            const totalTransporte = calcularTotalTransporte();
            const totalAlojamiento = calcularTotalAlojamiento();
            const totalIngresos = calcularTotalIngresos();
            const totalGastos = calcularTotalGastos();
            const balance = totalIngresos - totalGastos;
            
            return `
                <div class="presupuesto-container">
                    <div class="presupuesto-header">
                        <h3>üí∞ Presupuesto del Viaje</h3>
                        <button onclick="addIngreso()" class="btn-primary">‚ûï Agregar Ingreso</button>
                    </div>
                    
                    <div class="budget-summary">
                        <div class="budget-card total ${balance >= 0 ? 'positive' : 'negative'}">
                            <h3>Balance Actual</h3>
                            <div class="amount">$${balance.toLocaleString()}</div>
                            <p>${balance >= 0 ? 'Presupuesto disponible' : 'Sobrepasado'}</p>
                        </div>
                        
                        <div class="budget-card">
                            <h4>üí∞ Total Ingresos</h4>
                            <div class="amount green">$${totalIngresos.toLocaleString()}</div>
                        </div>
                        
                        <div class="budget-card">
                            <h4>üí∏ Total Gastos</h4>
                            <div class="amount red">$${totalGastos.toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="ingresos-section">
                        <h4>üí∞ Ingresos</h4>
                        <div class="ingresos-list">
                            ${(viajeData.presupuesto.ingresos || []).map(ingreso => `
                                <div class="ingreso-item">
                                    <span>${ingreso.descripcion}</span>
                                    <span class="amount-small green">$${ingreso.monto.toLocaleString()}</span>
                                    <button onclick="deleteIngreso('${ingreso.id}')" class="btn-tiny">üóëÔ∏è</button>
                                </div>
                            `).join('')}
                            ${(viajeData.presupuesto.ingresos || []).length === 0 ? '<p class="empty-state">No hay ingresos registrados</p>' : ''}
                        </div>
                    </div>

                    <div class="gastos-planificados">
                        <h4>üìä Gastos Planificados</h4>
                        <div class="gastos-breakdown">
                            <div class="gasto-categoria">
                                <span>üöÇ Transporte</span>
                                <span class="amount-small">$${totalTransporte.toLocaleString()}</span>
                            </div>
                            <div class="gasto-categoria">
                                <span>üè® Alojamiento</span>
                                <span class="amount-small">$${totalAlojamiento.toLocaleString()}</span>
                            </div>
                            <div class="gasto-categoria">
                                <span>üßæ Gastos Registrados</span>
                                <span class="amount-small">$${calcularTotalGastosReales().toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGastos() {
            const ciudades = getCiudadesUnicas();
            
            return `
                <div class="gastos-container">
                    <div class="gastos-header">
                        <h3>üßæ Gastos del Viaje</h3>
                        <button onclick="addGasto()" class="btn-primary">‚ûï Nuevo Gasto</button>
                    </div>
                    
                    <div class="gastos-grid">
                        ${(viajeData.gastos || []).map(gasto => `
                            <div class="gasto-card">
                                <div class="gasto-header">
                                    <span class="categoria">${gasto.categoria}</span>
                                    <span class="monto red">$${gasto.monto.toLocaleString()}</span>
                                </div>
                                <div class="gasto-detalle">
                                    <p><strong>${gasto.descripcion}</strong></p>
                                    <p>${gasto.ciudad} - ${formatDateShort(gasto.fecha)}</p>
                                </div>
                                <button onclick="deleteGasto('${gasto.id}')" class="btn-delete">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                        
                        ${(viajeData.gastos || []).length === 0 ? '<p class="empty-state">No hay gastos registrados</p>' : ''}
                    </div>
                </div>
            `;
        }

        // Funciones auxiliares
        function getCiudadesUnicas() {
            const ciudades = new Set();
            viajeData.itinerario.forEach(dia => {
                if (dia.ciudadDestino) {
                    // Limpiar nombres de ciudades
                    const ciudad = dia.ciudadDestino.split('/')[0].split(' ')[0];
                    if (ciudad && ciudad !== 'milan' && ciudad !== 'florencia') {
                        ciudades.add(ciudad.charAt(0).toUpperCase() + ciudad.slice(1));
                    }
                }
            });
            return Array.from(ciudades);
        }

        function getActividadesDia(diaId) {
            const dia = viajeData.itinerario.find(d => d.id === diaId);
            if (!dia || !dia.ciudadDestino) return '';
            
            const ciudad = dia.ciudadDestino.split('/')[0].split(' ')[0];
            const ciudadNormalizada = ciudad.charAt(0).toUpperCase() + ciudad.slice(1);
            const actividades = viajeData.actividades[ciudadNormalizada] || [];
            
            return actividades.slice(0, 2).join(', ') + (actividades.length > 2 ? '...' : '');
        }

        function calcularTotalTransporte() {
            return viajeData.itinerario.reduce((sum, dia) => {
                return sum + (dia.costoTransporte ? parseInt(dia.costoTransporte) : 0);
            }, 0);
        }

        function calcularTotalAlojamiento() {
            return viajeData.itinerario.reduce((sum, dia) => {
                return sum + (dia.costoAlojamiento ? parseInt(dia.costoAlojamiento) : 0);
            }, 0);
        }

        function calcularTotalIngresos() {
            return (viajeData.presupuesto.ingresos || []).reduce((sum, ingreso) => sum + ingreso.monto, 0);
        }

        function calcularTotalGastos() {
            return calcularTotalTransporte() + calcularTotalAlojamiento();
        }

        function calcularTotalGastosReales() {
            return (viajeData.gastos || []).reduce((sum, gasto) => sum + gasto.monto, 0);
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
        }

        // Funciones globales
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        };

        window.editRow = function(id) {
            const dia = viajeData.itinerario.find(d => d.id === id);
            if (!dia) return;
            
            openEditModal(dia);
        };

        function openEditModal(dia) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content large">
                    <h3>‚úèÔ∏è Editar D√≠a - ${formatDateShort(dia.fecha)}</h3>
                    <form id="editForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha:</label>
                                <input type="date" id="fecha" value="${dia.fecha}">
                            </div>
                            <div class="form-group">
                                <label>D√≠a de la semana:</label>
                                <input type="text" id="diaSemana" value="${dia.diaSemana || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ciudad origen:</label>
                                <input type="text" id="ciudadOrigen" value="${dia.ciudadOrigen || ''}">
                            </div>
                            <div class="form-group">
                                <label>Ciudad destino:</label>
                                <input type="text" id="ciudadDestino" value="${dia.ciudadDestino || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Pa√≠s:</label>
                                <input type="text" id="paisDestino" value="${dia.paisDestino || ''}">
                            </div>
                            <div class="form-group">
                                <label>Noches:</label>
                                <input type="number" id="noches" value="${dia.noches || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ruta/Transporte:</label>
                            <input type="text" id="rutaTransporte" value="${dia.rutaTransporte || ''}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Costo Transporte:</label>
                                <input type="number" id="costoTransporte" value="${dia.costoTransporte || ''}">
                            </div>
                            <div class="form-group">
                                <label>Costo Alojamiento:</label>
                                <input type="number" id="costoAlojamiento" value="${dia.costoAlojamiento || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Actividades:</label>
                            <input type="text" id="actividades" value="${dia.actividades || ''}">
                        </div>
                        <div class="form-group">
                            <label>Notas:</label>
                            <textarea id="notas" rows="3">${dia.notas || ''}</textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn-primary">üíæ Guardar</button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('editForm').onsubmit = function(e) {
                e.preventDefault();
                
                dia.fecha = document.getElementById('fecha').value;
                dia.diaSemana = document.getElementById('diaSemana').value;
                dia.ciudadOrigen = document.getElementById('ciudadOrigen').value;
                dia.ciudadDestino = document.getElementById('ciudadDestino').value;
                dia.paisDestino = document.getElementById('paisDestino').value;
                dia.noches = document.getElementById('noches').value;
                dia.rutaTransporte = document.getElementById('rutaTransporte').value;
                dia.costoTransporte = document.getElementById('costoTransporte').value;
                dia.costoAlojamiento = document.getElementById('costoAlojamiento').value;
                dia.actividades = document.getElementById('actividades').value;
                dia.notas = document.getElementById('notas').value;
                
                saveData('viajeData', viajeData);
                closeModal();
                renderApp();
            };
        }

        window.addActividad = function(ciudad) {
            const actividad = prompt(`Nueva actividad para ${ciudad}:`);
            if (actividad) {
                if (!viajeData.actividades[ciudad]) {
                    viajeData.actividades[ciudad] = [];
                }
                viajeData.actividades[ciudad].push(actividad);
                saveData('viajeData', viajeData);
                renderApp();
            }
        };

        window.editActividad = function(ciudad, index) {
            const actividad = viajeData.actividades[ciudad][index];
            const nuevaActividad = prompt('Editar actividad:', actividad);
            if (nuevaActividad !== null) {
                viajeData.actividades[ciudad][index] = nuevaActividad;
                saveData('viajeData', viajeData);
                renderApp();
            }
        };

        window.deleteActividad = function(ciudad, index) {
            if (confirm('¬øEliminar esta actividad?')) {
                viajeData.actividades[ciudad].splice(index, 1);
                saveData('viajeData', viajeData);
                renderApp();
            }
        };

        window.addIngreso = function() {
            const descripcion = prompt('Descripci√≥n del ingreso:');
            if (!descripcion) return;
            
            const monto = prompt('Monto:');
            if (!monto || isNaN(monto)) return;
            
            const ingreso = {
                id: Date.now().toString(),
                descripcion: descripcion,
                monto: parseInt(monto)
            };
            
            if (!viajeData.presupuesto.ingresos) {
                viajeData.presupuesto.ingresos = [];
            }
            
            viajeData.presupuesto.ingresos.push(ingreso);
            saveData('viajeData', viajeData);
            renderApp();
        };

        window.deleteIngreso = function(id) {
            if (confirm('¬øEliminar este ingreso?')) {
                viajeData.presupuesto.ingresos = viajeData.presupuesto.ingresos.filter(i => i.id !== id);
                saveData('viajeData', viajeData);
                renderApp();
            }
        };

        window.addGasto = function() {
            const ciudades = getCiudadesUnicas();
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>‚ûï Nuevo Gasto</h3>
                    <form id="gastoForm">
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <input type="text" id="descripcion" required>
                        </div>
                        <div class="form-group">
                            <label>Monto:</label>
                            <input type="number" id="monto" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a:</label>
                            <select id="categoria">
                                <option value="üçΩÔ∏è Comida">üçΩÔ∏è Comida</option>
                                <option value="üéØ Actividades">üéØ Actividades</option>
                                <option value="üõçÔ∏è Compras">üõçÔ∏è Compras</option>
                                <option value="üöó Transporte local">üöó Transporte local</option>
                                <option value="üíä Otros">üíä Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ciudad:</label>
                            <select id="ciudadGasto">
                                ${ciudades.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="date" id="fechaGasto" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn-primary">üíæ Guardar</button>
                            <button type="button" onclick="closeModal()" class="btn-secondary">‚ùå Cancelar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('gastoForm').onsubmit = function(e) {
                e.preventDefault();
                
                const gasto = {
                    id: Date.now().toString(),
                    descripcion: document.getElementById('descripcion').value,
                    monto: parseInt(document.getElementById('monto').value),
                    categoria: document.getElementById('categoria').value,
                    ciudad: document.getElementById('ciudadGasto').value,
                    fecha: document.getElementById('fechaGasto').value
                };
                
                if (!viajeData.gastos) viajeData.gastos = [];
                viajeData.gastos.push(gasto);
                
                saveData('viajeData', viajeData);
                closeModal();
                renderApp();
            };
        };

        window.deleteGasto = function(id) {
            if (confirm('¬øEliminar este gasto?')) {
                viajeData.gastos = viajeData.gastos.filter(g => g.id !== id);
                saveData('viajeData', viajeData);
                renderApp();
            }
        };

        window.addDay = function() {
            const lastDay = viajeData.itinerario[viajeData.itinerario.length - 1];
            const newDate = new Date(lastDay.fecha);
            newDate.setDate(newDate.getDate() + 1);
            
            const newDay = {
                id: Date.now(),
                fecha: newDate.toISOString().split('T')[0],
                diaSemana: '',
                ciudadOrigen: '',
                ciudadDestino: '',
                paisDestino: '',
                rutaTransporte: '',
                noches: '',
                costoTransporte: '',
                costoAlojamiento: '',
                actividades: '',
                notas: ''
            };
            
            viajeData.itinerario.push(newDay);
            saveData('viajeData', viajeData);
            renderApp();
        };

        window.closeModal = function() {
            const modal = document.querySelector('.modal');
            if (modal) modal.remove();
        };

        window.exportData = function() {
            const data = JSON.stringify(viajeData, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'viaje-europa-2025.json';
            a.click();
        };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #0f172a;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            padding: 6px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .connected {
            background: #dcfce7;
            color: #166534;
        }
        
        .offline {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-btn:hover {
            color: #3b82f6;
            background: #f8fafc;
        }
        
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #f8fafc;
        }
        
        .tab-content {
            display: none;
            padding: 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            background: white;
            overflow-x: auto;
        }
        
        .itinerario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1200px;
        }
        
        .itinerario-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        
        .itinerario-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        
        .day-row:hover {
            background: #fafbfc;
        }
        
        .fecha {
            font-weight: 600;
            color: #3b82f6;
            min-width: 60px;
        }
        
        .ruta {
            font-weight: 500;
            min-width: 150px;
        }
        
        .center {
            text-align: center;
            min-width: 60px;
        }
        
        .costo {
            text-align: right;
            font-weight: 500;
            color: #059669;
            min-width: 80px;
        }
        
        .transporte {
            max-width: 150px;
        }
        
        .actividades-cell {
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .notas {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #6b7280;
        }
        
        .actions {
            width: 60px;
            text-align: center;
        }
        
        .btn-edit {
            background: none;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-edit:hover {
            background: #f3f4f6;
        }
        
        .actions-bar {
            background: white;
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-small {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-tiny {
            background: none;
            border: 1px solid #d1d5db;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .btn-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }
        
        .btn-delete:hover {
            background: #fee2e2;
        }
        
        /* Actividades */
        .actividades-container {
            padding: 30px;
            background: white;
        }
        
        .actividades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .actividades-header h3 {
            font-size: 18px;
            color: #0f172a;
        }
        
        .ciudades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .ciudad-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }
        
        .ciudad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .ciudad-header h4 {
            color: #0f172a;
            font-size: 16px;
        }
        
        .actividades-list {
            min-height: 100px;
        }
        
        .actividad-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .actividad-item:last-child {
            border-bottom: none;
        }
        
        .actividad-text {
            flex: 1;
            font-size: 14px;
        }
        
        .actividad-actions {
            display: flex;
            gap: 4px;
        }
        
        .empty-activities {
            color: #6b7280;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        
        /* Presupuesto */
        .presupuesto-container {
            padding: 30px;
            background: white;
        }
        
        .presupuesto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .presupuesto-header h3 {
            font-size: 18px;
            color: #0f172a;
        }
        
        .budget-summary {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .budget-card {
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .budget-card.total {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
        }
        
        .budget-card.positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .budget-card.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .budget-card h3, .budget-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .amount.green {
            color: #059669;
        }
        
        .amount.red {
            color: #dc2626;
        }
        
        .amount-small {
            font-weight: 600;
        }
        
        .amount-small.green {
            color: #059669;
        }
        
        .amount-small.red {
            color: #dc2626;
        }
        
        .ingresos-section, .gastos-planificados {
            margin-bottom: 30px;
        }
        
        .ingresos-section h4, .gastos-planificados h4 {
            margin-bottom: 16px;
            color: #0f172a;
        }
        
        .ingresos-list, .gastos-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .ingreso-item, .gasto-categoria {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        /* Gastos */
        .gastos-container {
            padding: 30px;
            background: white;
        }
        
        .gastos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .gastos-header h3 {
            font-size: 18px;
            color: #0f172a;
        }
        
        .gastos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .gasto-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            position: relative;
        }
        
        .gasto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .categoria {
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .monto {
            font-weight: 600;
        }
        
        .monto.red {
            color: #dc2626;
        }
        
        .gasto-detalle p {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .gasto-detalle p:last-child {
            color: #6b7280;
            font-size: 12px;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            color: #6b7280;
            padding: 40px;
            font-style: italic;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content.large {
            max-width: 700px;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #0f172a;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
        }
        
        .form-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
            }
            
            .stats {
                gap: 12px;
            }
            
            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }
            
            .budget-summary {
                grid-template-columns: 1fr;
            }
            
            .ciudades-grid, .gastos-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
            
            .actions-bar, .actividades-container, .presupuesto-container, .gastos-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h2>Cargando...</h2>
        </div>
    </div>
</body>
</html>
